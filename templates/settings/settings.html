{% extends 'base.html' %}
{% load static %}

{% block title %}Settings - Contact Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
<link rel="stylesheet" href="{% static 'css/animations.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white mb-2">
                    <i class="ri-settings-3-line"></i> Settings
                </h1>
                <p class="text-white-50 mb-0">Customize your experience and preferences</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button @click="exportSettings()" class="btn btn-light btn-lg me-2">
                        <i class="ri-download-line"></i> Export
                    </button>
                    <button @click="showImportModal()" class="btn btn-outline-light btn-lg">
                        <i class="ri-upload-2-line"></i> Import
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4" x-data="settingsManager()">
    <!-- Settings Navigation -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <ul class="nav nav-pills nav-fill" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" 
                            @click="activeTab = 'general'"
                            :class="{'active': activeTab === 'general'}">
                        <i class="fas fa-user me-2"></i>General
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" 
                            @click="activeTab = 'appearance'"
                            :class="{'active': activeTab === 'appearance'}">
                        <i class="fas fa-palette me-2"></i>Appearance
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" 
                            @click="activeTab = 'notifications'"
                            :class="{'active': activeTab === 'notifications'}">
                        <i class="fas fa-bell me-2"></i>Notifications
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" 
                            @click="activeTab = 'features'"
                            :class="{'active': activeTab === 'features'}">
                        <i class="fas fa-toggle-on me-2"></i>Features
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" 
                            @click="activeTab = 'privacy'"
                            :class="{'active': activeTab === 'privacy'}">
                        <i class="fas fa-shield-alt me-2"></i>Privacy
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- General Settings -->
    <div x-show="activeTab === 'general'" x-transition>
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>General Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Language</label>
                            <select x-model="settings.language" @change="saveSettings()" class="form-select">
                                <option value="en">English</option>
                                <option value="es">Spanish</option>
                                <option value="fr">French</option>
                                <option value="de">German</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Timezone</label>
                            <select x-model="settings.timezone" @change="saveSettings()" class="form-select">
                                <option value="UTC">UTC</option>
                                <option value="America/New_York">Eastern Time</option>
                                <option value="America/Chicago">Central Time</option>
                                <option value="America/Denver">Mountain Time</option>
                                <option value="America/Los_Angeles">Pacific Time</option>
                                <option value="Europe/London">London</option>
                                <option value="Europe/Paris">Paris</option>
                                <option value="Asia/Tokyo">Tokyo</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Items per page</label>
                            <select x-model="settings.items_per_page" @change="saveSettings()" class="form-select">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Dashboard Layout</label>
                            <select x-model="settings.dashboard_layout" @change="saveSettings()" class="form-select">
                                <option value="grid">Grid</option>
                                <option value="list">List</option>
                                <option value="compact">Compact</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Settings -->
    <div x-show="activeTab === 'appearance'" x-transition>
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Appearance Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Theme</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" id="theme-light" value="light" x-model="settings.theme" @change="saveSettings()">
                                <label class="btn btn-outline-primary" for="theme-light">
                                    <i class="fas fa-sun me-2"></i>Light
                                </label>
                                
                                <input type="radio" class="btn-check" id="theme-dark" value="dark" x-model="settings.theme" @change="saveSettings()">
                                <label class="btn btn-outline-primary" for="theme-dark">
                                    <i class="fas fa-moon me-2"></i>Dark
                                </label>
                                
                                <input type="radio" class="btn-check" id="theme-auto" value="auto" x-model="settings.theme" @change="saveSettings()">
                                <label class="btn btn-outline-primary" for="theme-auto">
                                    <i class="fas fa-adjust me-2"></i>Auto
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Settings -->
    <div x-show="activeTab === 'notifications'" x-transition>
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notification Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.email_notifications" 
                                   @change="saveSettings()" 
                                   id="email-notifications">
                            <label class="form-check-label" for="email-notifications">
                                Email Notifications
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.push_notifications" 
                                   @change="saveSettings()" 
                                   id="push-notifications">
                            <label class="form-check-label" for="push-notifications">
                                Push Notifications
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.import_completion_notifications" 
                                   @change="saveSettings()" 
                                   id="import-notifications">
                            <label class="form-check-label" for="import-notifications">
                                Import Completion Notifications
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.export_completion_notifications" 
                                   @change="saveSettings()" 
                                   id="export-notifications">
                            <label class="form-check-label" for="export-notifications">
                                Export Completion Notifications
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Toggles -->
    <div x-show="activeTab === 'features'" x-transition>
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Feature Toggles</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <template x-for="feature in featureToggles" :key="feature.id">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1" x-text="feature.name"></h6>
                                            <p class="card-text text-muted small mb-0" x-text="feature.description"></p>
                                            <small class="text-muted" x-text="feature.category"></small>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" 
                                                   :checked="feature.is_enabled"
                                                   :disabled="feature.is_global"
                                                   @change="toggleFeature(feature.id)"
                                                   :id="'feature-' + feature.id">
                                            <label class="form-check-label" :for="'feature-' + feature.id"></label>
                                        </div>
                                    </div>
                                    <div x-show="feature.is_global" class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-globe me-1"></i>Globally controlled
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Settings -->
    <div x-show="activeTab === 'privacy'" x-transition>
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Privacy & Security Settings</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Data Retention (days)</label>
                            <input type="number" class="form-control" 
                                   x-model="settings.data_retention_days" 
                                   @change="saveSettings()" 
                                   min="1" max="3650">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Session Timeout (minutes)</label>
                            <input type="number" class="form-control" 
                                   x-model="settings.session_timeout_minutes" 
                                   @change="saveSettings()" 
                                   min="15" max="1440">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.allow_data_sharing" 
                                   @change="saveSettings()" 
                                   id="data-sharing">
                            <label class="form-check-label" for="data-sharing">
                                Allow Data Sharing
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.allow_analytics_tracking" 
                                   @change="saveSettings()" 
                                   id="analytics-tracking">
                            <label class="form-check-label" for="analytics-tracking">
                                Allow Analytics Tracking
                            </label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" 
                                   x-model="settings.two_factor_enabled" 
                                   @change="saveSettings()" 
                                   id="two-factor">
                            <label class="form-check-label" for="two-factor">
                                Two-Factor Authentication
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <button @click="resetSettings()" class="btn btn-outline-danger">
                    <i class="fas fa-undo me-2"></i>Reset to Defaults
                </button>
                <div>
                    <button @click="saveAllSettings()" class="btn btn-primary me-2">
                        <i class="fas fa-save me-2"></i>Save All Changes
                    </button>
                    <button @click="loadSettings()" class="btn btn-outline-secondary">
                        <i class="fas fa-sync me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-3">Loading settings...</p>
    </div>
</div>

<!-- Import Settings Modal -->
<div class="modal fade" id="importSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Settings</h5>
                <button type="button" class="btn-close" data-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form @submit.prevent="importSettings()">
                    <div class="mb-3">
                        <label class="form-label">Settings File</label>
                        <input type="file" class="form-control" 
                               @change="handleFileSelect($event)" 
                               accept=".json" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Select a JSON file exported from this application to restore your settings.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button @click="importSettings()" 
                        class="btn btn-primary"
                        :disabled="isImporting">
                    <span x-show="!isImporting">Import Settings</span>
                    <span x-show="isImporting">Importing...</span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.nav-pills .nav-link {
    border-radius: 0.5rem;
    margin-right: 0.5rem;
}

.nav-pills .nav-link.active {
    background-color: #007bff;
    border-color: #007bff;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-check:checked + .btn-outline-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/settings-manager.js' %}"></script>
<script>
// Initialize settings manager
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Alpine !== 'undefined') {
        Alpine.data('settingsManager', settingsManager);
    }
});
</script>
{% endblock %}
