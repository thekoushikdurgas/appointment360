{% extends 'base.html' %}
{% load static %}

{% block title %}Contacts - Contact Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
<link rel="stylesheet" href="{% static 'css/animations.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white mb-2">
                    <i class="ri-contacts-line"></i> Contacts
                </h1>
                <p class="text-white-50 mb-0">Manage your contact database efficiently</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'contacts:create' %}" class="btn btn-light btn-lg">
                    <i class="ri-add-line"></i> Add Contact
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4" x-data="contactSelection()">
    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);">
                <div class="text-center">
                    <i class="ri-contacts-line fa-3x text-white"></i>
                    <h2 class="text-white mt-2 mb-0" data-animate-counter data-target="{{ page_obj.paginator.count }}">0</h2>
                    <p class="text-white mb-0">Total Contacts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);">
                <div class="text-center">
                    <i class="ri-checkbox-circle-line fa-3x text-white"></i>
                    <h2 class="text-white mt-2 mb-0">{{ active_contacts|default:"0" }}</h2>
                    <p class="text-white mb-0">Active Contacts</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);">
                <div class="text-center">
                    <i class="ri-building-line fa-3x text-white"></i>
                    <h2 class="text-white mt-2 mb-0">{{ industries|length|default:"0" }}</h2>
                    <p class="text-white mb-0">Industries</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #9C27B0 0%, #BA68C8 100%);">
                <div class="text-center">
                    <i class="ri-global-line fa-3x text-white"></i>
                    <h2 class="text-white mt-2 mb-0">{{ countries|length|default:"0" }}</h2>
                    <p class="text-white mb-0">Countries</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filter Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="ri-filter-line"></i> Search & Filter
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <div class="form-floating">
                        <input type="text" name="search" class="form-control" 
                               id="search" placeholder="Search Contacts"
                               value="{{ search }}">
                        <label for="search"><i class="ri-search-line"></i> Search Contacts</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        <select name="industry" class="form-select" id="industry">
                            <option value="">All Industries</option>
                            {% for ind in industries %}
                            <option value="{{ ind }}" {% if ind == request.GET.industry %}selected{% endif %}>
                                {{ ind }}
                            </option>
                            {% endfor %}
                        </select>
                        <label for="industry"><i class="ri-factory-line"></i> Industry</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-floating">
                        <select name="country" class="form-select" id="country">
                            <option value="">All Countries</option>
                            {% for cntry in countries %}
                            <option value="{{ cntry }}" {% if cntry == request.GET.country %}selected{% endif %}>
                                {{ cntry }}
                            </option>
                            {% endfor %}
                        </select>
                        <label for="country"><i class="ri-global-line"></i> Country</label>
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-auth-primary me-2">
                        <i class="ri-search-line"></i> Apply Filters
                    </button>
                    <a href="{% url 'contacts:list' %}" class="btn btn-outline-secondary">
                        <i class="ri-close-line"></i> Clear All
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Contacts Table -->
    <div class="card" x-data="contactSelection()">
        <div class="card-header" style="background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-white">
                    <i class="ri-contacts-book-2-line"></i> Contact List
                </h5>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge bg-light text-dark">{{ page_obj.paginator.count }} contacts</span>
                    <span x-show="selectedCount > 0" class="badge bg-warning text-dark">
                        <i class="ri-checkbox-line"></i> <span x-text="selectedCount"></span> selected
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Bulk Actions Toolbar -->
        <div x-show="selectedCount > 0" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform -translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="card-header bg-light border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted">
                        <i class="ri-checkbox-line"></i> 
                        <span x-text="selectedCount"></span> contacts selected
                    </span>
                </div>
                <div class="d-flex gap-2">
                    <button @click="exportSelected()" 
                            class="btn btn-success btn-sm"
                            :disabled="isProcessing">
                        <i class="ri-download-line"></i> Export Selected
                    </button>
                    <button @click="bulkDelete()" 
                            class="btn btn-danger btn-sm"
                            :disabled="isProcessing">
                        <i class="ri-delete-bin-6-line"></i> Delete Selected
                    </button>
                    <button @click="clearSelection()" 
                            class="btn btn-outline-secondary btn-sm">
                        <i class="ri-close-line"></i> Clear Selection
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 data-table">
                    <thead>
                        <tr>
                            <th width="50">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           @change="toggleAll()"
                                           :checked="allSelected"
                                           :indeterminate="someSelected && !allSelected">
                                </div>
                            </th>
                            <th>ID</th>
                            <th><i class="ri-user-line"></i> Name</th>
                            <th><i class="ri-building-line"></i> Company</th>
                            <th><i class="ri-mail-line"></i> Email</th>
                            <th><i class="ri-phone-line"></i> Phone</th>
                            <th><i class="ri-factory-line"></i> Industry</th>
                            <th><i class="ri-global-line"></i> Country</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for contact in contacts %}
                        <tr class="fade-in" 
                            :class="{'table-success': isSelected({{ contact.id }})}"
                            style="animation-delay: {{ forloop.counter0|mul:0.1 }}s">
                            <td>
                                <div class="form-check">
                                    <input class="form-check-input checkbox-animate" 
                                           type="checkbox" 
                                           :value="{{ contact.id }}"
                                           @change="toggleSelection({{ contact.id }})"
                                           :checked="isSelected({{ contact.id }})">
                                </div>
                            </td>
                            <td>{{ contact.id }}</td>
                            <td><strong>{{ contact.full_name }}</strong></td>
                            <td>{{ contact.company|default:"-" }}</td>
                            <td><a href="mailto:{{ contact.email }}" class="text-decoration-none">{{ contact.email }}</a></td>
                            <td>{{ contact.phone|default:"-" }}</td>
                            <td>
                                {% if contact.industry %}
                                    <span class="table-badge table-badge-primary">{{ contact.industry }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ contact.country|default:"-" }}</td>
                            <td>
                                <div class="table-actions">
                                    <a href="{% url 'contacts:update' contact.pk %}" class="action-btn action-btn-edit" title="Edit">
                                        <i class="ri-edit-line"></i>
                                    </a>
                                    <a href="{% url 'contacts:delete' contact.pk %}" class="action-btn action-btn-delete delete-btn" title="Delete">
                                        <i class="ri-delete-bin-6-line"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="ri-contacts-line"></i>
                                    </div>
                                    <div class="empty-state-title">No Contacts Found</div>
                                    <div class="empty-state-text">
                                        {% if search %}
                                            No contacts match your search criteria. Try adjusting your filters.
                                        {% else %}
                                            Get started by adding your first contact.
                                        {% endif %}
                                    </div>
                                    {% if not search %}
                                    <div class="empty-state-action">
                                        <a href="{% url 'contacts:create' %}" class="btn btn-auth-primary">
                                            <i class="ri-add-line"></i> Add Your First Contact
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}">
                            <i class="ri-arrow-left-line"></i> Previous
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Previous</span>
                    </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if request.GET.industry %}&industry={{ request.GET.industry }}{% endif %}{% if request.GET.country %}&country={{ request.GET.country }}{% endif %}">
                            Next <i class="ri-arrow-right-line"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Next</span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Animate counter on load
document.addEventListener('DOMContentLoaded', function() {
    const counters = document.querySelectorAll('[data-animate-counter]');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        if (isNaN(target)) return;
        
        const duration = 2000;
        const increment = target / (duration / 16);
        let current = 0;
        
        const updateCounter = () => {
            current += increment;
            if (current < target) {
                counter.textContent = Math.floor(current);
                requestAnimationFrame(updateCounter);
            } else {
                counter.textContent = target;
            }
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    updateCounter();
                    observer.unobserve(entry.target);
                }
            });
        });
        
        observer.observe(counter);
    });
});
</script>

<script>
// Contact Selection Alpine.js Component
function contactSelection() {
    return {
        selectedContacts: new Set(),
        isProcessing: false,
        
        init() {
            // Load saved selections from localStorage
            this.loadSavedSelections();
        },
        
        get selectedCount() {
            return this.selectedContacts.size;
        },
        
        get allSelected() {
            const visibleCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            return visibleCheckboxes.length > 0 && this.selectedContacts.size === visibleCheckboxes.length;
        },
        
        get someSelected() {
            return this.selectedContacts.size > 0;
        },
        
        isSelected(contactId) {
            return this.selectedContacts.has(contactId);
        },
        
        toggleSelection(contactId) {
            if (this.selectedContacts.has(contactId)) {
                this.selectedContacts.delete(contactId);
            } else {
                this.selectedContacts.add(contactId);
            }
            this.saveSelections();
        },
        
        toggleAll() {
            const visibleCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            const allVisibleIds = Array.from(visibleCheckboxes).map(cb => parseInt(cb.value));
            
            if (this.allSelected) {
                // Deselect all visible
                allVisibleIds.forEach(id => this.selectedContacts.delete(id));
            } else {
                // Select all visible
                allVisibleIds.forEach(id => this.selectedContacts.add(id));
            }
            this.saveSelections();
        },
        
        clearSelection() {
            this.selectedContacts.clear();
            this.saveSelections();
        },
        
        saveSelections() {
            localStorage.setItem('contactSelections', JSON.stringify(Array.from(this.selectedContacts)));
        },
        
        loadSavedSelections() {
            try {
                const saved = localStorage.getItem('contactSelections');
                if (saved) {
                    this.selectedContacts = new Set(JSON.parse(saved));
                }
            } catch (error) {
                console.error('Error loading saved selections:', error);
            }
        },
        
        async exportSelected() {
            if (this.selectedContacts.size === 0) return;
            
            this.isProcessing = true;
            
            try {
                const response = await fetch('/api/contacts/bulk-export/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        contact_ids: Array.from(this.selectedContacts),
                        format: 'csv'
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `contacts_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    this.showNotification('Export completed successfully!', 'success');
                } else {
                    const error = await response.json();
                    this.showNotification(error.message || 'Export failed', 'error');
                }
            } catch (error) {
                console.error('Export error:', error);
                this.showNotification('Export failed', 'error');
            } finally {
                this.isProcessing = false;
            }
        },
        
        async bulkDelete() {
            if (this.selectedContacts.size === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${this.selectedContacts.size} contacts? This action cannot be undone.`)) {
                return;
            }
            
            this.isProcessing = true;
            
            try {
                const response = await fetch('/api/contacts/bulk-delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken()
                    },
                    body: JSON.stringify({
                        contact_ids: Array.from(this.selectedContacts)
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.showNotification(`${result.deleted_count} contacts deleted successfully`, 'success');
                    this.clearSelection();
                    // Reload page to reflect changes
                    setTimeout(() => location.reload(), 1000);
                } else {
                    const error = await response.json();
                    this.showNotification(error.message || 'Delete failed', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                this.showNotification('Delete failed', 'error');
            } finally {
                this.isProcessing = false;
            }
        },
        
        showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            
            notification.innerHTML = `
                <i class="${type === 'success' ? 'ri-check-line' : type === 'error' ? 'ri-alert-line' : 'ri-information-line'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()" aria-label="Close"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        },
        
        getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        }
    };
}
</script>

<style>
/* Enhanced Contact List Styling */
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 12px;
    font-weight: bold;
}

.table-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.table-badge-primary {
    background-color: #e3f2fd;
    color: #1976d2;
}

.table-actions {
    display: flex;
    gap: 0.25rem;
}

.action-btn {
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.375rem;
    text-decoration: none;
    transition: all 0.2s ease-in-out;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.action-btn-edit {
    background-color: #fff3cd;
    color: #856404;
}

.action-btn-edit:hover {
    background-color: #ffeaa7;
    color: #6c5ce7;
}

.action-btn-delete {
    background-color: #f8d7da;
    color: #721c24;
}

.action-btn-delete:hover {
    background-color: #f5c6cb;
    color: #721c24;
}

.action-btn-view {
    background-color: #d1ecf1;
    color: #0c5460;
}

.action-btn-view:hover {
    background-color: #bee5eb;
    color: #0c5460;
}

/* Enhanced metric cards */
.metric-card {
    border-radius: 12px;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    overflow: hidden;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

/* Enhanced table styling */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
    transform: scale(1.01);
    transition: all 0.2s ease-in-out;
}

/* Loading states */
.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Enhanced animations */
.fade-in {
    animation: fadeIn 0.6s ease-out forwards;
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.scale-up {
    animation: scaleUp 0.3s ease-out forwards;
}

@keyframes scaleUp {
    from { 
        transform: scale(0.9); 
        opacity: 0; 
    }
    to { 
        transform: scale(1); 
        opacity: 1; 
    }
}

/* Enhanced button styling */
.btn {
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.btn:active {
    transform: translateY(0);
}

/* Enhanced form controls */
.form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    border-color: #007bff;
}

.form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    border-color: #007bff;
}

/* Enhanced card styling */
.card {
    transition: box-shadow 0.3s ease-in-out;
}

.card:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

/* Enhanced badge styling */
.badge {
    transition: all 0.2s ease-in-out;
}

.badge:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}
