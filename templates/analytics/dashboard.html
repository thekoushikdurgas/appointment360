{% extends 'base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Contact Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
<link rel="stylesheet" href="{% static 'css/animations.css' %}">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white mb-2">
                    <i class="ri-line-chart-line"></i> Analytics Dashboard
                </h1>
                <p class="text-white-50 mb-0">Comprehensive insights and statistics about your contacts</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group" role="group">
                    <button @click="refreshCharts()" 
                            class="btn btn-light btn-lg me-2"
                            :disabled="isLoading">
                        <i class="fas fa-sync-alt" :class="{'fa-spin': isLoading}"></i> Refresh
                    </button>
                    <a href="{% url 'exports:history' %}" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4" x-data="analyticsDashboard()">
    <!-- Filters -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Analytics Filters
                    </h5>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <select @change="updateDateRange()" x-model="selectedDays" class="form-select">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button @click="exportCharts()" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> Export Charts
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);">
                <div class="card-body text-white text-center py-4">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h2 class="mb-1 counter-animate" x-text="stats.total_contacts.toLocaleString()"></h2>
                    <p class="mb-0 fs-6">Total Contacts</p>
                    <small x-show="stats.recent_contacts > 0" x-text="'+' + stats.recent_contacts + ' this week'"></small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="background: linear-gradient(135deg, #4CAF50 0%, #81C784 100%);">
                <div class="card-body text-white text-center py-4">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <h2 class="mb-1 counter-animate" x-text="stats.active_contacts.toLocaleString()"></h2>
                    <p class="mb-0 fs-6">Active Contacts</p>
                    <small x-text="'(' + Math.round(stats.active_contacts / stats.total_contacts * 100) + '% active)'"></small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%);">
                <div class="card-body text-white text-center py-4">
                    <i class="fas fa-upload fa-3x mb-3"></i>
                    <h2 class="mb-1 counter-animate" x-text="stats.total_imports.toLocaleString()"></h2>
                    <p class="mb-0 fs-6">Total Imports</p>
                    <small x-text="stats.import_success_rate + '% success rate'"></small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card metric-card h-100" style="background: linear-gradient(135deg, #9C27B0 0%, #BA68C8 100%);">
                <div class="card-body text-white text-center py-4">
                    <i class="fas fa-download fa-3x mb-3"></i>
                    <h2 class="mb-1 counter-animate" x-text="stats.total_exports.toLocaleString()"></h2>
                    <p class="mb-0 fs-6">Total Exports</p>
                    <small x-show="stats.recent_exports > 0" x-text="'+' + stats.recent_exports + ' this week'"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="row">
        <!-- Industry Distribution -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-industry me-2"></i>
                        Industry Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="industry-chart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Country Distribution -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>
                        Country Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <div id="country-chart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Contact Growth Trend -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Contact Growth Trend
                    </h5>
                </div>
                <div class="card-body">
                    <div id="growth-chart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Contact Status -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-pie-chart me-2"></i>
                        Contact Status
                    </h5>
                </div>
                <div class="card-body">
                    <div id="status-chart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Top Companies -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-building me-2"></i>
                        Top Companies by Contact Count
                    </h5>
                </div>
                <div class="card-body">
                    <div id="companies-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mt-3">Loading analytics data...</p>
    </div>
</div>

<style>
.chart-container {
    height: 400px;
    width: 100%;
}

.metric-card {
    border-radius: 12px;
    transition: transform 0.3s ease-in-out;
}

.metric-card:hover {
    transform: translateY(-5px);
}

/* Responsive chart heights */
@media (max-width: 768px) {
    .chart-container {
        height: 300px;
    }
}

/* Chart loading state */
.chart-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 400px;
    background: #f8f9fa;
    border-radius: 8px;
}

.chart-loading .spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/analytics-charts.js' %}"></script>
<script>
// Initialize analytics dashboard
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Alpine !== 'undefined') {
        Alpine.data('analyticsDashboard', analyticsDashboard);
    }
});
</script>
{% endblock %}
