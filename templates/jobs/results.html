{% extends 'base.html' %}
{% load static %}

{% block title %}Scraping Results - Contact Manager{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white mb-2">
                    <i class="fas fa-check-circle"></i> Scraping Complete
                </h1>
                <p class="text-white-50 mb-0">Successfully scraped {{ job_count }} jobs from the target website</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'jobs:scraper' %}" class="btn btn-light btn-lg">
                    <i class="fas fa-plus"></i> Scrape Another
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-4">
    <!-- Summary Card -->
    <div class="card shadow-lg border-0 rounded-lg mb-4">
        <div class="card-header bg-gradient-success text-white text-center py-3">
            <h4 class="mb-0">
                <i class="fas fa-briefcase me-2"></i> Scraped Jobs Summary
            </h4>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4">
                    <div class="metric-card">
                        <h2 class="text-primary mb-0" data-animate-counter data-target="{{ job_count }}">0</h2>
                        <p class="text-muted mb-0">Total Jobs</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card">
                        <h2 class="text-success mb-0">{{ jobs|length }}</h2>
                        <p class="text-muted mb-0">Processed</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="metric-card">
                        <button class="btn btn-primary btn-lg" onclick="exportJobs()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jobs List -->
    <div class="card shadow-lg border-0 rounded-lg">
        <div class="card-header bg-gradient-primary text-white py-3">
            <h4 class="mb-0">
                <i class="fas fa-list me-2"></i> Job Listings
            </h4>
        </div>
        <div class="card-body">
            {% if jobs %}
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="jobs-table">
                    <thead class="bg-light">
                        <tr>
                            <th>Title</th>
                            <th>Company</th>
                            <th>Location</th>
                            <th>Description</th>
                            <th>URL</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr>
                            <td><strong>{{ job.title|default:"N/A" }}</strong></td>
                            <td>{{ job.company|default:"N/A" }}</td>
                            <td>{{ job.location|default:"N/A" }}</td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;">
                                    {{ job.description|default:"N/A" }}
                                </div>
                            </td>
                            <td>
                                {% if job.url %}
                                    <a href="{{ job.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewJobDetails({{ forloop.counter0 }})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                <h5>No jobs found</h5>
                <p class="text-muted">The scraper didn't find any job listings on this page.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-briefcase"></i> Job Details
                </h5>
                <button type="button" class="btn-close" data-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="job-details-content">
                <!-- Job details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
const jobs = {{ jobs|safe }};

function viewJobDetails(index) {
    const job = jobs[index];
    const modal = new CustomModal(document.getElementById('jobDetailsModal'));
    const content = document.getElementById('job-details-content');
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-tag"></i> Title</h6>
                <p class="bg-light p-2 rounded" style="background-color: var(--card); padding: 0.5rem; border-radius: 0.5rem;">${job.title || 'N/A'}</p>
            </div>
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-building"></i> Company</h6>
                <p class="bg-light p-2 rounded">${job.company || 'N/A'}</p>
            </div>
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-map-marker-alt"></i> Location</h6>
                <p class="bg-light p-2 rounded">${job.location || 'N/A'}</p>
            </div>
            <div class="col-md-6 mb-3">
                <h6><i class="fas fa-link"></i> URL</h6>
                <p class="bg-light p-2 rounded">
                    ${job.url ? `<a href="${job.url}" target="_blank">${job.url}</a>` : 'N/A'}
                </p>
            </div>
            <div class="col-12 mb-3">
                <h6><i class="fas fa-align-left"></i> Description</h6>
                <p class="bg-light p-3 rounded" style="background-color: var(--card); padding: 0.75rem; border-radius: 0.5rem;">${job.description || 'N/A'}</p>
            </div>
            <div class="col-12">
                <h6><i class="fas fa-code"></i> Raw Data</h6>
                <pre class="bg-light p-3 rounded" style="background-color: var(--card); padding: 0.75rem; border-radius: 0.5rem;"><code>${JSON.stringify(job, null, 2)}</code></pre>
            </div>
        </div>
    `;
    
    modal.show();
}

function exportJobs() {
    if (jobs.length === 0) {
        alert('No jobs to export');
        return;
    }
    
    // Convert to CSV
    const headers = ['Title', 'Company', 'Location', 'Description', 'URL'];
    const csvContent = [
        headers.join(','),
        ...jobs.map(job => [
            `"${(job.title || '').replace(/"/g, '""')}"`,
            `"${(job.company || '').replace(/"/g, '""')}"`,
            `"${(job.location || '').replace(/"/g, '""')}"`,
            `"${(job.description || '').replace(/"/g, '""')}"`,
            `"${(job.url || '').replace(/"/g, '""')}"`
        ].join(','))
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'scraped_jobs.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Initialize DataTable
$(document).ready(function() {
    $('#jobs-table').DataTable({
        pageLength: 25,
        order: [[0, 'asc']],
        responsive: true
    });
    
    // Animate counter
    const counter = document.querySelector('[data-animate-counter]');
    if (counter) {
        const target = parseInt(counter.getAttribute('data-target'));
        const duration = 2000;
        const increment = target / (duration / 16);
        let current = 0;
        
        const updateCounter = () => {
            current += increment;
            if (current < target) {
                counter.textContent = Math.floor(current);
                requestAnimationFrame(updateCounter);
            } else {
                counter.textContent = target;
            }
        };
        
        updateCounter();
    }
});
</script>
{% endblock %}
